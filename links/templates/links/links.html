{%extends 'base.html'%}
{%load static%}
{%block head%}
<script src="{% static 'js/bs_form.js' %}"></script>
<link rel="stylesheet" href="{% static 'users/css/auth_form.css' %}">
{%endblock%}
{%block content%}
<style>
    #collection-form {
        display: flex;
        align-items: flex-end;
        gap: 10px;
    }


    #link-collection-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
</style>
<h1>links</h1>
<div class="container" id="link-collection-container">
    <button class="btn btn-primary" id="create-link-collection-btn">+ создать</button>
</div>
<div class="container">
    <div class="collapse" id="collapseCollectionForm">
        <form action="" id="collection-form">
            <div class="invalid-feedback non-field-invalid-feedback"></div>
            <input type="hidden" class="form-control" required name="id">
            <div class="mb-3">
                <label for="collection-name" class="form-label">Название</label>
                <input type="text" class="form-control" id="collection-name" required name="name">
                <div class="invalid-feedback"></div>
            </div>
            <div class="mb-3">
                <label for="collection-description" class="form-label">Описание</label>
                <input type="text" class="form-control" id="collection-description" required name="description">
                <div class="invalid-feedback"></div>
            </div>
            <div class="mb-3"><button type="submit" class="btn btn-primary">Сохранить</button></div>
        </form>
    </div>
</div>

<!-- DELETE COLLECTION MODAL -->
<div class="modal fade" id="deleteCollectionModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="deleteCollectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCollectionModalLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" id="delete-collection-form">
                    <div class="invalid-feedback non-field-invalid-feedback"></div>
                    <input type="text" class="form-control" required name="id">
                    <button type="submit" class="btn btn-primary">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    var csrf = '{{csrf_token}}'
    var headers = {
        "Content-Type": "application/json",
        "X-CSRFToken": csrf,
    }
    class LinkCollectionsApi {
        constructor() {

        }

        async list() {
            var url = "{%url 'links:linkcollections-list'%}"
            var response = await fetch(url, {
                method: 'GET',
                headers: headers,
            })
            return await response.json()
        }

        async create(data) {
            var url = "{%url 'links:linkcollections-list'%}"
            var response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            })
            return response
        }

        async deleteCollection(collectionId) {
            var url = "{%url 'links:linkcollections-list'%}" + collectionId + '/'
            var response = await fetch(url, {
                method: 'DELETE',
                headers: headers,
            })
            return await response
        }

        async updateCollection(collectionId, data) {
            var url = "{%url 'links:linkcollections-list'%}" + collectionId + '/'
            var response = await fetch(url, {
                method: 'PATCH',
                headers: headers,
                body: JSON.stringify(data)
            })
            return response
        }
    }

    class LinkCollectionButtonView {
        constructor(collectionData, deleteEventhandler, updateEventHandler) {
            this.data = collectionData
            this.deleteEventhandler = deleteEventhandler
            this.updateEventHandler = updateEventHandler
            this.elem = null
        }

        createElem() {
            var collectionData = this.data
            const container = document.createElement('div');
            container.className = 'dropdown';

            const button = document.createElement('button');
            button.className = 'btn btn-secondary dropdown-toggle';
            button.type = 'button';
            button.id = `dropdownMenuButton-${collectionData.id}`;
            button.setAttribute('data-bs-toggle', 'dropdown');
            button.setAttribute('aria-expanded', 'false');
            button.textContent = collectionData.name;

            const ul = document.createElement('ul');
            ul.className = 'dropdown-menu';
            ul.setAttribute('aria-labelledby', button.id);
            var actionLink = this._createActionLink('Изменить', this.changeCollectionClickEvent)
            ul.appendChild(actionLink);
            var actionLink = this._createActionLink('Удалить', this.deleteCollectionClickEvent)
            ul.appendChild(actionLink);


            container.appendChild(button);
            container.appendChild(ul);
            this.elem = container
            return this.elem
        }

        _createActionLink(text, clickFunction) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = text;
            li.appendChild(a);
            a.addEventListener('click', clickFunction.bind(this))
            return li
        }
        changeCollectionClickEvent() {
            console.log('changeCollectionClickEvent')
            var changeForm = new BsJsonForm(collectionFormElem)
            changeForm.feed(this.data)
            changeForm.submitFunction = this.updateEventHandler
            collapseCollectionForm.show()
        }

        remove() {
            this.elem.remove()
        }

        deleteCollectionClickEvent() {
            console.log('deleteCollectionClickEvent')
            var deleteForm = new BsJsonForm(deleteCollectionForm)
            var data = { 'id': this.data['id'] }
            deleteForm.feed(data)
            deleteForm.submitFunction = this.deleteEventhandler
            console.log(deleteForm._submitFunction)
            deleteCollectionModal.show()
        }

    }

    class LinkCollectionsView {
        constructor() {
            this.container = document.getElementById('link-collection-container')
            this.collectionButtons = new Map()
        }

        async drawButtons() {
            var buttonsData = await linkCollectionApi.list()
            console.log(buttonsData)
            buttonsData.forEach(collectionData => {
                
                this._drawButton(collectionData)
            })
        }

        _drawButton(collectionData) {
            var collectionButton = new LinkCollectionButtonView(
                collectionData,
                this.deleteCollectionEvent.bind(this),
                this.updateCollectionEvent.bind(this),
            )
            this.collectionButtons.set(collectionData.id, collectionButton)
            var elem = collectionButton.createElem()
            this.container.appendChild(elem)
        }

        createLinkCollectionEventClick() {
            collapseCollectionForm.show()
            var form = new BsJsonForm(collectionFormElem)
            form.submitFunction = this.createLinkCollectionHandler.bind(this)
        }

        async createLinkCollectionHandler(e) {
            e.preventDefault()
            var form = BsJsonForm.getInstance(collectionFormElem)
            var data = form.toDict()
            var response = await linkCollectionApi.create(data)
            if (response.ok) {
                var data = await response.json()
                this._drawButton(data)
                collapseCollectionForm.hide()
            } else {
                alert(await response.text())
            }
        }

        async deleteCollectionEvent(e) {
            e.preventDefault()
            var deleteForm = BsJsonForm.getInstance(deleteCollectionForm)
            var data = deleteForm.toDict()
            var collectionId = data['id']
            var response = await linkCollectionApi.deleteCollection(collectionId)
            deleteCollectionModal.hide()
            const collectionButton = this.collectionButtons.get(collectionId);
            if (collectionButton) {
                collectionButton.remove(); // удаляем из DOM
                this.collectionButtons.delete(collectionId); // удаляем из карты
            }
        }

        async updateCollectionEvent(e) {
            e.preventDefault()
            var updateForm = BsJsonForm.getInstance(collectionFormElem)
            var data = updateForm.toDict()
            var collectionId = data['id']
            var response = await linkCollectionApi.updateCollection(collectionId, data)
            if (response.ok) {
                var newData = await response.json()
                this.updateButton(newData['id'], newData)
                collapseCollectionForm.hide()
            } else {
                alert(await response.text())
            }
        }

        updateButton(collectionId, NewData) {
            var oldcollectionBtn = this.collectionButtons.get(collectionId)
            this.collectionButtons.delete(collectionId)
            var collectionButton = new LinkCollectionButtonView(
                NewData,
                this.deleteCollectionEvent.bind(this),
                this.updateCollectionEvent.bind(this),
            )
            this.collectionButtons.set(NewData.id, collectionButton)
            var elem = collectionButton.createElem()
            oldcollectionBtn.elem.replaceWith(elem)
        }

    }
    const createLinkCollectionBtn = document.getElementById('create-link-collection-btn')
    var collectionFormElem = document.getElementById('collection-form')
    var deleteCollectionForm = document.getElementById('delete-collection-form')
    const linkCollectionApi = new LinkCollectionsApi()
    const linkCollectionsView = new LinkCollectionsView()


    var collapseCollectionFormElem = document.getElementById('collapseCollectionForm')
    var collapseCollectionForm = new bootstrap.Collapse(collapseCollectionFormElem, {
        toggle: false
    })

    const deleteCollectionModalElem = document.getElementById('deleteCollectionModal')
    const deleteCollectionModal = new bootstrap.Modal(deleteCollectionModalElem)

    createLinkCollectionBtn.addEventListener('click', linkCollectionsView.createLinkCollectionEventClick.bind(linkCollectionsView))
    linkCollectionsView.drawButtons()
</script>
{%endblock%}